(function(){if(window.CodeLeaf===undefined)throw"CodeLeaf Core not included.";if(window.CodeLeaf.Bundles===undefined)throw"CodeLeaf Bundle not included.";if(window.CodeLeaf.Tokenizer===undefined)throw"CodeLeaf Tokenizer not included.";CodeLeaf.Editor=new Class({construct:function(e,t){this.targetNode=e;this.options=Object.append({editable:!0,bundle:"Generic",brush:"CodeLeaf",stateChange:null},t);this.setup()},setup:function(){var e=this;this.hasTooltip=!1;this.currentTooltip=null;this.hasSnippet=!1;this.currentSnippet=null;this.currentSnippetIndex=-1;this.makeIndentation=!0;this.hasAutocomplete=!1;this.currentAutocomplete=null;this.Brush=this.options.brush;this.Bundle=this.options.bundle;this.BundleObject=CodeLeaf.Bundles.get(this.Bundle);this.targetNode.set("spellcheck","false");this.targetNode.addClass(this.Brush.toLowerCase());this.targetNode.addClass(this.Bundle.toLowerCase());this.BundleObject.relatedTo&&this.BundleObject.relatedTo.length>0&&this.targetNode.addClass(this.BundleObject.relatedTo.join(" ").toLowerCase());this.targetNode.isInput()===!1&&this.targetNode.set("editable",this.options.editable.toString());this.tokenizerObject=new CodeLeaf.Tokenizer(this.targetNode,this.BundleObject.SyntaxTokens);var t=(new Node("div",{"class":"codeleaf-editor"})).wrap(this.targetNode),n=(new Node("div",{"class":"codeleaf-editor-viewport"})).inject(t,"top");this.observe();this.invokeSyntaxHighlight()},observe:function(){var e=this;this.targetNode.set({keyup:function(t){t=new EventObject(t);e.targetNode.saveCaretPosition();var n=e.targetNode.textObject();typeOf(e.options.stateChange)==="function"&&e.options.stateChange(n);typeOf(e.BundleObject.KeyBindings)==="object"&&Object.keys(e.BundleObject.KeyBindings).length>0&&Object.forEach(e.BundleObject.KeyBindings,function(n,r){if(t.isSequence(r)===!0){e.targetNode.saveCaretPosition();n(e);e.invokeSyntaxHighlight()}})},keydown:function(t){t=new EventObject(t);e.targetNode.saveCaretPosition();if(t.isSequence("return")===!0){t.stop();e.newLine(e.targetNode);e.escapeSnippet();e.targetNode.saveCaretPosition()}if(t.isSequence("tab")===!0){t.stop();var n=e.targetNode.textObject().textBefore.trimWhitespace().replace(/(<([^>]+)>)/ig,"").lastWord();if(e.BundleObject.hasSnippet(n)===!0&&e.hasSnippet===!1){e.makeIndentation=!1;e.hasSnippet=!0;e.currentSnippet=e.BundleObject.Snippets[n];e.insertSnippet(n,e.currentSnippet)}else if(e.hasSnippet===!0){e.currentSnippetIndex++;e.currentSnippet.hasOwnProperty("tabSelections")===!1&&(e.currentSnippet.tabSelections=[]);if(e.currentSnippetIndex<e.currentSnippet.tabSelections.length)e.tabSnippet(e.currentSnippet);else if(e.currentSnippet.hasOwnProperty("escape")&&e.currentSnippet.escape===!0){var r=e.targetNode.textObject(),i=e.currentSnippet.insertText,s=i[i.length-1];if(s!==null&&r.currentLine.contains(s)){var o=r.currentLine.lastIndexOf(s),u=r.linesBeforeCurrent.length+o,a=u+s.length;if(r.linesBeforeCurrent&&r.linesBeforeCurrent.lastIndexOf("\n")!==-1){u++;a++}e.escapeSnippet();e.targetNode.selectRange(a,a)}}else e.escapeSnippet()}else if(e.makeIndentation===!0&&e.hasSnippet===!1){var f=e.targetNode.textObject().textAfter.substring(0,1),l=e.BundleObject.TypingPairs,c=Object.keys(l).filter(function(e){return l[e]===f}).pop();if(f===":"||l.hasOwnProperty(c)){var h=e.targetNode.selectionStart()+f.length;e.targetNode.selectRange(h,h)}else{e.enTab();e.invokeSyntaxHighlight()}}e.targetNode.saveCaretPosition()}if(t.isSequence("shift + tab")===!0){t.stop();e.deTab(e.targetNode);e.targetNode.saveCaretPosition()}if(t.isSequence("escape")===!0||t.isSequence("return")===!0){t.stop();e.targetNode.saveCaretPosition()}t.isSequence("space")===!0&&e.invokeSyntaxHighlight();if(t.isSequence("backspace")===!0){var p=e.targetNode.get("text"),u=e.targetNode.selectionStart(),a=e.targetNode.selectionEnd(),d=p.slice(u-1,u),f=p.slice(u,u+1),l=e.BundleObject.TypingPairs;if(e.BundleObject.hasTypingPair(d)===!0&&e.BundleObject.typingPair(d)===f){var a=e.targetNode.selectionEnd();e.targetNode.set("text",e.targetNode.get("text").splice(a-1,1));e.targetNode.selectRange(a);e.invokeSyntaxHighlight()}}},keypress:function(t){t=new EventObject(t);if(e.BundleObject.hasTypingPair(t.key)===!0){t.stop();var n=t.key,r=e.BundleObject.TypingPairs[t.key];e.typingPairs(n,r);e.targetNode.saveCaretPosition()}},paste:function(){(function(){e.targetNode.set("html",e.targetNode.get("html").replace(/(<\w+)(\s.+?>)/g,"$1>").replace(/<\/?pre>/g,"").replace(/(<div>)?<br>|(<div>)+/gi,"\n").replace(/<\/div>/gi,"").replace(/&nbsp;/gi," "));e.invokeSyntaxHighlight()}).delay(10)},click:function(){e.escapeSnippet()}})},invokeSyntaxHighlight:function(){if(this.targetNode.isInput()===!1){this.targetNode.saveCaretPosition();var e=this.targetNode.get("text").replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/\u00a0/g," "),t=this.tokenizerObject.getOutput(e);this.targetNode.set("html",t);this.targetNode.restoreCaretPosition()}}});CodeLeaf.Editor.implement({newLine:function(){var e=this.targetNode.textObject(),t=e.textBefore,n=t.lastIndexOf("\n")+1,r=(t.slice(n).match(/^\s+/)||[""])[0];r=r.replace(/\r?\n\s/g,"\n");this.targetNode.insertText(r,"\n","",!0,"moveAfter");this.invokeSyntaxHighlight()},enTab:function(){if(this.targetNode.hasSelection()===!1)this.targetNode.insertText("","	",null,!1,"moveAfter");else{var e=this.targetNode.isInput()===!0?"value":"text",t=this.targetNode.textObject(),n=t.selectionStart,r=t.selectionEnd,i=t.textBefore,s=t.textAfter,o=t.textSelected,u=i.lastIndexOf("\n")+1;i=i.splice(u,0,"	");o=o.replace(/\r?\n/g,"\n	");n++;r=n+o.length;this.targetNode.set(e,i+o+s);this.targetNode.selectRange(n,r)}this.invokeSyntaxHighlight()},deTab:function(){var e=this.targetNode.isInput()===!0?"value":"text",t=this.targetNode.textObject(),n=t.selectionStart,r=t.selectionEnd,i=t.textBefore,s=t.textAfter,o=t.textSelected,u=i.lastIndexOf("\n")+1;/\s/.test(i.charAt(u))&&(i=i.splice(u,1));o=o.replace(/\r?\n\s/g,"\n");n=i.length;r=n+o.length;this.targetNode.set(e,i+o+s);this.targetNode.selectRange(n,r);this.invokeSyntaxHighlight()},typingPairs:function(e,t){this.targetNode.insertText(this.targetNode.selectedText(),e,t,!0);this.invokeSyntaxHighlight()},insertSnippet:function(e,t){this.targetNode.saveCaretPosition();var n=this.targetNode.isInput()===!0?"value":"text",r=this.targetNode.textObject(),i=r.selectionStart,s=r.selectionEnd,o=r.textBefore,u=r.textAfter,a=r.textSelected;o=o.substring(0,o.length-e.length);this.targetNode.set(n,"");this.targetNode.insertText("",o+t.insertText[0],t.insertText[1]+u);this.invokeSyntaxHighlight()},tabSnippet:function(e){var t=this,n=function(e){var n=r.currentLine.lastIndexOf(e),i=r.linesBeforeCurrent.length+n,s=i+e.length;if(r.linesBeforeCurrent&&r.linesBeforeCurrent.lastIndexOf("\n")!==-1){i++;s++}t.targetNode.selectRange(i,s)};e.hasOwnProperty("tabSelections")===!1&&(e.tabSelections=[]);var r=this.targetNode.textObject(),i=e.tabSelections[this.currentSnippetIndex];if(r.currentLine.contains(i)===!0)n(i);else{var s=this.currentSnippetIndex,o=i;do{s++;o=e.tabSelections[s]}while(o!==undefined&&s<e.tabSelections.length&&r.currentLine.contains(o)===!1);if(o!==undefined){this.currentSnippetIndex=s;n(o)}else this.escapeSnippet()}this.invokeSyntaxHighlight()},escapeSnippet:function(){this.makeIndentation=!0;this.currentSnippetIndex=-1;this.currentSnippet=null;this.hasSnippet=!1;this.invokeSyntaxHighlight()}})}).call(window);